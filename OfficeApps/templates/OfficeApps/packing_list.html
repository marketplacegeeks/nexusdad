{% extends "OfficeApps/base.html" %}

{% block content %}
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between;">
    <div>
      <h2>Packing List</h2>
      <p class="muted">Search, paginate, and control Packing Lists.</p>
    </div>
    {% if can_create %}
    <button id="btnCreate" class="btn" style="background:#16a34a; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">
      + Create Packing List
    </button>
    {% endif %}
  </div>

  <div class="card">
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <input id="searchInput" type="text" placeholder="Search by number, PI number, consignee..." style="flex:1; padding:8px; border:1px solid #e5e7eb; border-radius:8px;">
      <button id="btnSearch" class="btn" style="background:#3b82f6; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Search</button>
      <button id="btnClear" class="btn" style="background:#64748b; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Clear</button>
    </div>

    <div style="overflow:auto;">
      <table id="packingTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th style="padding:8px;">Packing List No</th>
            <th style="padding:8px;">Packing List Date</th>
            <th style="padding:8px;">Consignee</th>
            <th style="padding:8px;">Status</th>
            <th style="padding:8px;">Actions</th>
          </tr>
        </thead>
        <tbody id="packingTbody">
          <!-- Rows injected by JS -->
        </tbody>
      </table>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
      <div id="pageInfo" class="muted">Page 1</div>
      <div style="display:flex; gap:8px;">
        <button id="btnPrev" class="btn" style="background:#e5e7eb; color:#0f172a; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Prev</button>
        <button id="btnNext" class="btn" style="background:#e5e7eb; color:#0f172a; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Next</button>
      </div>
    </div>
  </div>

  <div id="roleFlags" style="display:none"
       data-admin="{{ is_admin|yesno:'true,false' }}"
       data-maker="{{ is_maker|yesno:'true,false' }}"
       data-checker="{{ is_checker|yesno:'true,false' }}"
       data-can-create="{{ can_create|yesno:'true,false' }}">
  </div>

  <script>
    // Role flags sourced from hidden DOM dataset
    const flagsEl = document.getElementById("roleFlags");
    const ROLE = {
      admin: flagsEl ? flagsEl.dataset.admin === "true" : false,
      maker: flagsEl ? flagsEl.dataset.maker === "true" : false,
      checker: flagsEl ? flagsEl.dataset.checker === "true" : false,
      canCreate: flagsEl ? flagsEl.dataset.canCreate === "true" : false
    };

    const API_BASE = "/api/master/packing-lists/";

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    let state = {
      page: 1,
      search: "",
      next: null,
      previous: null,
      count: 0,
    };

    function statusBadge(status) {
      const colors = {
        "DRAFT": "#64748b",
        "PENDING_APPROVAL": "#f59e0b",
        "APPROVED": "#16a34a",
        "REWORK": "#ef4444",
        "PERMANENTLY_REJECTED": "#ef4444",
      };
      const bg = colors[status] || "#64748b";
      const text = (status || "").replace("_"," ");
      return '<span style="display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; color:#fff; background:'+bg+';">'+text+'</span>';
    }

    function getAllowedActions(row) {
      const s = row.status;
      const actions = [];
      const submitAction = { key: "submit", label: s === "REWORK" ? "Re-submit for Approval" : "Submit for Approval", handler: () => submitPackingList(row.id) };
      const approveAction = { key: "approve", label: "Approve", handler: () => approvePackingList(row.id) };
      const rejectAction = { key: "reject", label: "Reject", handler: () => rejectPackingList(row.id) };
      const permRejectAction = { key: "permanently_reject", label: "Permanently Reject", handler: () => permanentlyRejectPackingList(row.id) };
      const deleteAction = { key: "delete", label: "Delete", handler: () => deactivatePackingList(row.id) };
      const pdfAction = { key: "pdf", label: "Download PDF", handler: () => pdfPackingList(row.id) };

      if (ROLE.admin) {
        actions.push(submitAction, approveAction, rejectAction, permRejectAction, deleteAction, pdfAction);
        return actions;
      }

      if (ROLE.maker) {
        if (s === "DRAFT") actions.push(submitAction, deleteAction);
        if (s === "REWORK") actions.push(submitAction);
        if (s === "APPROVED") actions.push(pdfAction);
      }

      if (ROLE.checker) {
        if (s === "PENDING_APPROVAL") actions.push(approveAction, rejectAction);
        if (s === "APPROVED") actions.push(pdfAction);
      }

      return actions;
    }

    function rowHtml(row) {
      const actions = getAllowedActions(row);
      const actionBtnId = "actions-" + row.id;
      let actionsHtml = "";
      if (actions.length) {
        actionsHtml = '<div style="position:relative; display:inline-block;">' +
          '<button class="btn" id="'+actionBtnId+'" style="background:#3b82f6; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer;">Actions ▾</button>' +
          '<div class="dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #e5e7eb; box-shadow:0 4px 16px rgba(0,0,0,0.1); border-radius:8px; min-width:180px; z-index:10;">' +
            actions.map(a => '<a href="#" data-key="'+a.key+'" style="display:block; padding:8px 10px; color:#0f172a; text-decoration:none;">'+a.label+'</a>').join('') +
          '</div>' +
        '</div>';
      }
      const date = row.date || "";
      const consignee = row.consignee_name || "";
      const status = statusBadge(row.status);
      const canEditRow = (ROLE.admin) || (ROLE.maker && (row.status === "DRAFT" || row.status === "REWORK")) || (ROLE.checker && row.status === "REWORK");
      const numberCell = canEditRow && row.id
        ? '<a href="/app/packing-list/create/?id='+row.id+'" style="color:#2563eb; text-decoration:underline;">'+(row.number || "")+'</a>'
        : (row.number || "");

      return '<tr data-id="'+row.id+'" style="border-bottom:1px solid #e5e7eb;">' +
        '<td style="padding:8px;">'+numberCell+'</td>' +
        '<td style="padding:8px;">'+date+'</td>' +
        '<td style="padding:8px;">'+consignee+'</td>' +
        '<td style="padding:8px;">'+status+'</td>' +
        '<td style="padding:8px;">'+actionsHtml+'</td>' +
      '</tr>';
    }

    function bindRowInteractions(tr, row) {
      const dropdownWrap = tr.querySelector(".dropdown");
      const actionsBtn = tr.querySelector("button[id^='actions-']");
      if (actionsBtn && dropdownWrap) {
        actionsBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          dropdownWrap.style.display = dropdownWrap.style.display === "none" || dropdownWrap.style.display === "" ? "block" : "none";
        });
        dropdownWrap.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const a = e.target.closest("a[data-key]");
          if (!a) return;
          const key = a.getAttribute("data-key");
          const actions = getAllowedActions(row);
          const found = actions.find(x => x.key === key);
          dropdownWrap.style.display = "none";
          if (found) found.handler();
        });
        // Hide dropdown when clicking outside
        document.addEventListener("click", (ev) => {
          if (!dropdownWrap.contains(ev.target) && ev.target !== actionsBtn) {
            dropdownWrap.style.display = "none";
          }
        });
      }
    }

    async function fetchJSON(url, opts={}) {
      const resp = await fetch(url, {
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCsrfToken(),
        },
        ...opts,
      });
      if (!resp.ok) {
        let msg = "Request failed";
        try { const err = await resp.json(); msg = err.detail || JSON.stringify(err); } catch(e){}
        throw new Error(msg);
      }
      return resp.headers.get("content-type") && resp.headers.get("content-type").includes("application/json")
        ? resp.json()
        : resp.blob();
    }

    async function loadPackingLists() {
      const url = API_BASE + "?page=" + state.page + (state.search ? ("&search=" + encodeURIComponent(state.search)) : "");
      try {
        const data = await fetchJSON(url);
        const tbody = document.getElementById("packingTbody");
        tbody.innerHTML = "";
        (data.results || []).forEach(row => {
          const html = rowHtml(row);
          const temp = document.createElement("tbody");
          temp.innerHTML = html.trim();
          const tr = temp.firstChild;
          tbody.appendChild(tr);
          bindRowInteractions(tr, row);
        });
        state.next = data.next;
        state.previous = data.previous;
        state.count = data.count || 0;
        const pageInfo = document.getElementById("pageInfo");
        pageInfo.textContent = "Page " + state.page + (state.count ? (" • " + state.count + " records") : "");
      } catch (e) {
        alert("Failed to load packing lists: " + e.message);
      }
    }

    async function submitPackingList(id) {
      try {
        await fetchJSON(API_BASE + id + "/submit/", { method: "POST", body: "{}" });
        await loadPackingLists();
      } catch(e) { alert("Submit failed: " + e.message); }
    }

    async function approvePackingList(id) {
      try {
        await fetchJSON(API_BASE + id + "/approve/", { method: "POST", body: "{}" });
        await loadPackingLists();
      } catch(e) { alert("Approve failed: " + e.message); }
    }

    async function rejectPackingList(id) {
      const reason = prompt("Enter rejection comments (required):", "");
      if (!reason || !reason.trim()) {
        alert("Rejection requires comments.");
        return;
      }
      const payload = JSON.stringify({ notes: reason.trim() });
      try {
        await fetchJSON(API_BASE + id + "/reject/", { method: "POST", body: payload });
        await loadPackingLists();
      } catch(e) { alert("Reject failed: " + e.message); }
    }

    async function permanentlyRejectPackingList(id) {
      if (!confirm("Permanently reject this packing list? This cannot be reversed.")) return;
      try {
        await fetchJSON(API_BASE + id + "/permanently_reject/", { method: "POST", body: "{}" });
        await loadPackingLists();
      } catch(e) { alert("Permanent reject failed: " + e.message); }
    }

    async function deactivatePackingList(id) {
      if (!confirm("Delete (deactivate) this Draft packing list?")) return;
      try {
        await fetchJSON(API_BASE + id + "/deactivate/", { method: "POST", body: "{}" });
        await loadPackingLists();
      } catch(e) { alert("Delete failed: " + e.message); }
    }

    async function pdfPackingList(id) {
      try {
        const resp = await fetch(API_BASE + id + "/pdf/", { method: "GET", credentials: "same-origin" });
        if (!resp.ok) {
          let msg = "PDF failed";
          try { const err = await resp.json(); msg = err.detail || JSON.stringify(err); } catch(e){}
          alert(msg);
          return;
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "PackingList_" + id + ".pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch(e) { alert("PDF failed: " + e.message); }
    }

    document.getElementById("btnSearch").addEventListener("click", () => {
      state.search = document.getElementById("searchInput").value.trim();
      state.page = 1;
      loadPackingLists();
    });
    document.getElementById("btnClear").addEventListener("click", () => {
      document.getElementById("searchInput").value = "";
      state.search = "";
      state.page = 1;
      loadPackingLists();
    });
    document.getElementById("btnPrev").addEventListener("click", () => {
      if (state.previous) {
        state.page = Math.max(1, state.page - 1);
        loadPackingLists();
      }
    });
    document.getElementById("btnNext").addEventListener("click", () => {
      if (state.next) {
        state.page = state.page + 1;
        loadPackingLists();
      }
    });

    // Bind Create navigation
    const btnCreate = document.getElementById("btnCreate");
    if (btnCreate) { btnCreate.addEventListener("click", () => { window.location.href = "/app/packing-list/create/"; }); }

    // Initial load
    loadPackingLists();
  </script>
{% endblock %}