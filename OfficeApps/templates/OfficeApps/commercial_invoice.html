{% extends "OfficeApps/base.html" %}

{% block content %}
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between;">
    <div>
      <h2>Commercial Invoice</h2>
      <p class="muted">Search, paginate, and control Commercial Invoices.</p>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <a href="/app/commercial-invoice/create/" class="btn" style="background:#16a34a; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; text-decoration:none;">
        + Add Commercial Invoice
      </a>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <input id="searchInput" type="text" placeholder="Search by number, consignee, exporter..." style="flex:1; padding:8px; border:1px solid #e5e7eb; border-radius:8px;">
      <button id="btnSearch" class="btn" style="background:#3b82f6; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Search</button>
      <button id="btnClear" class="btn" style="background:#64748b; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Clear</button>
    </div>

    <div style="overflow-x:auto; overflow-y:visible;">
      <table id="invoiceTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th style="padding:8px;">Date of Creation</th>
            <th style="padding:8px;">Consignee</th>
            <th style="padding:8px; text-align:right;">Amount</th>
            <th style="padding:8px; text-align:right;">Total Amount (USD)</th>
            <th style="padding:8px;">Status</th>
            <th style="padding:8px;">Actions</th>
          </tr>
        </thead>
        <tbody id="invoiceTbody">
          <!-- Rows injected by JS -->
        </tbody>
      </table>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
      <div id="pageInfo" class="muted">Page 1</div>
      <div style="display:flex; gap:8px;">
        <button id="btnPrev" class="btn" style="background:#e5e7eb; color:#0f172a; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Prev</button>
        <button id="btnNext" class="btn" style="background:#e5e7eb; color:#0f172a; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Next</button>
      </div>
    </div>
  </div>

  <div id="roleFlags" style="display:none"
       data-admin="{{ is_admin|yesno:'true,false' }}"
       data-maker="{{ is_maker|yesno:'true,false' }}"
       data-checker="{{ is_checker|yesno:'true,false' }}"
       data-can-create="{{ can_create|yesno:'true,false' }}">
  </div>

  <script>
    // Role flags
    const flagsEl = document.getElementById("roleFlags");
    const ROLE = {
      admin: flagsEl ? flagsEl.dataset.admin === "true" : false,
      maker: flagsEl ? flagsEl.dataset.maker === "true" : false,
      checker: flagsEl ? flagsEl.dataset.checker === "true" : false,
      canCreate: flagsEl ? flagsEl.dataset.canCreate === "true" : false
    };

    const API_BASE = "/api/master/commercial-invoices/";

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    let state = {
      page: 1,
      search: "",
      next: null,
      previous: null,
      count: 0,
    };

    let activeDropdown = null;
    let dropdownHandlersBound = false;

    function positionDropdown(dropdown, anchor) {
      if (!dropdown || !anchor) return;
      const rect = anchor.getBoundingClientRect();
      const top = rect.bottom + 4;
      const left = rect.left;
      const maxLeft = window.innerWidth - dropdown.offsetWidth - 8;
      dropdown.style.left = Math.max(8, Math.min(left, maxLeft)) + "px";
      dropdown.style.top = Math.min(top, window.innerHeight - dropdown.offsetHeight - 8) + "px";
    }

    function openDropdown(dropdown, anchor) {
      closeDropdown();
      dropdown._originalParent = dropdown.parentElement;
      dropdown._originalNext = dropdown.nextSibling;
      dropdown._anchor = anchor;
      document.body.appendChild(dropdown);
      dropdown.style.position = "fixed";
      dropdown.style.display = "block";
      dropdown.style.zIndex = "3000";
      positionDropdown(dropdown, anchor);
      activeDropdown = dropdown;
    }

    function closeDropdown() {
      if (!activeDropdown) return;
      const dropdown = activeDropdown;
      dropdown.style.display = "none";
      dropdown.style.position = "absolute";
      dropdown.style.top = "";
      dropdown.style.left = "";
      dropdown.style.zIndex = "10";
      if (dropdown._originalParent) {
        dropdown._originalParent.insertBefore(dropdown, dropdown._originalNext);
      }
      activeDropdown = null;
    }

    function bindDropdownGlobalHandlers() {
      if (dropdownHandlersBound) return;
      dropdownHandlersBound = true;
      document.addEventListener("click", (ev) => {
        if (!activeDropdown) return;
        const anchor = activeDropdown._anchor;
        if (activeDropdown.contains(ev.target) || (anchor && (anchor === ev.target || anchor.contains(ev.target)))) {
          return;
        }
        closeDropdown();
      });
      window.addEventListener("resize", () => {
        if (activeDropdown) positionDropdown(activeDropdown, activeDropdown._anchor);
      });
      window.addEventListener("scroll", () => {
        if (activeDropdown) positionDropdown(activeDropdown, activeDropdown._anchor);
      }, true);
    }

    function statusBadge(status) {
      const colors = {
        "DRAFT": "#64748b",
        "PENDING_APPROVAL": "#f59e0b",
        "APPROVED": "#16a34a",
        "REJECTED": "#ef4444",
        "DISABLED": "#0f172a",
      };
      const bg = colors[status] || "#64748b";
      const label = status.replace("_"," ");
      return '<span style="display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; color:#fff; background:'+bg+';">'+label+'</span>';
    }

    function currencyUSD(v) {
      try {
        return Number(v).toLocaleString(undefined, { style: "currency", currency: "USD" });
      } catch(e) { return v; }
    }

    function currencyGeneric(v) {
      try {
        return Number(v).toLocaleString();
      } catch(e) { return v; }
    }

    function formatTodayDdMonYYYY() {
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, "0");
      return dd + months[d.getMonth()] + d.getFullYear();
    }

    function sanitizeFilenameComponent(s) {
      return (s || "").trim().replace(/[\\/:*?"<>|]+/g, "-").replace(/\s+/g, " ").trim();
    }

    function getAllowedActions(row) {
      const s = row.status;
      const actions = [];
      const submitAction = { key: "submit", label: s === "REJECTED" ? "Re-submit for Approval" : "Submit for Approval", handler: () => submitInvoice(row.id) };
      const approveAction = { key: "approve", label: "Approve", handler: () => approveInvoice(row.id) };
      const rejectAction = { key: "reject", label: "Reject (with comments)", handler: () => rejectInvoice(row.id) };
      const disableAction = { key: "disable", label: "Disable", handler: () => disableInvoice(row.id) };
      const pdfDraftAction = { key: "pdf_draft", label: "Download Draft PDF", handler: () => pdfInvoiceDraft(row.id, row.consignee_name) };
      const pdfAction = { key: "pdf", label: "Download Final PDF", handler: () => pdfInvoice(row.id, row.consignee_name) };
      const viewCommentsAction = { key: "view_comments", label: "View Rejection Comments", handler: () => viewRejectionComments(row.id) };

      if (ROLE.admin) {
        // Admin: full control
        if (s !== "APPROVED" && s !== "DISABLED") actions.push(submitAction);
        if (s === "PENDING_APPROVAL" || s === "REJECTED") actions.push(approveAction);
        if (s === "PENDING_APPROVAL") actions.push(rejectAction);
        if (s === "APPROVED") actions.push(disableAction);
        if (s !== "APPROVED") actions.push(pdfDraftAction);
        if (s === "APPROVED") actions.push(pdfAction);
        if (s === "REJECTED") actions.push(viewCommentsAction);
        return actions;
      }

      if (ROLE.maker) {
        // Maker: create handled via other flow; can submit, view draft until approval; final PDF after approval
        if (s === "DRAFT" || s === "REJECTED") actions.push(submitAction);
        if (s !== "APPROVED" && s !== "DISABLED") actions.push(pdfDraftAction);
        if (s === "APPROVED") actions.push(pdfAction);
        if (s === "REJECTED") actions.push(viewCommentsAction);
      }

      if (ROLE.checker) {
        // Checker: approve/reject; disable approved
        if (s === "PENDING_APPROVAL" || s === "REJECTED") actions.push(approveAction);
        if (s === "PENDING_APPROVAL") actions.push(rejectAction);
        if (s === "APPROVED") actions.push(disableAction, pdfAction);
        if (s === "REJECTED") actions.push(viewCommentsAction);
      }

      return actions;
    }

    function rowHtml(row) {
      const actions = getAllowedActions(row);
      const actionBtnId = "actions-" + row.id;
      let actionsHtml = "";
      if (actions.length) {
        actionsHtml = '<div style="position:relative; display:inline-block;">' +
          '<button class="btn" id="'+actionBtnId+'" style="background:#3b82f6; color:#fff; border:none; border-radius:8px; padding:4px 8px; cursor:pointer;">Actions ▾</button>' +
          '<div class="dropdown" style="display:none; position:absolute; background:#fff; border:1px solid #e5e7eb; box-shadow:0 4px 16px rgba(0,0,0,0.1); border-radius:8px; min-width:200px; z-index:10;">' +
            actions.map(a => '<a href="#" data-key="'+a.key+'" style="display:block; padding:8px 10px; color:#0f172a; text-decoration:none;">'+a.label+'</a>').join('') +
          '</div>' +
        '</div>';
      }

      const createdAt = row.created_at || row.date || "";
      const consignee = row.consignee_name || "";
      const amount = currencyGeneric(row.amount || 0);
      const totalUsd = currencyUSD(row.total_amount_usd || 0);
      let statusCell = statusBadge(row.status);

      // Rework indicator (if REJECTED)
      if (row.status === "REJECTED") {
        statusCell += ' <span title="Rework required" style="display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; color:#fff; background:#ef4444;">Rework Required</span>';
      }

      return '<tr data-id="'+row.id+'" style="border-bottom:1px solid #e5e7eb;">' +
        '<td style="padding:8px;">'+createdAt+'</td>' +
        '<td style="padding:8px;">'+consignee+'</td>' +
        '<td style="padding:8px; text-align:right;">'+amount+'</td>' +
        '<td style="padding:8px; text-align:right;">'+totalUsd+'</td>' +
        '<td style="padding:8px;">'+statusCell+'</td>' +
        '<td style="padding:8px;">'+actionsHtml+'</td>' +
      '</tr>';
    }

    function bindRowInteractions(tr, row) {
      const dropdownWrap = tr.querySelector(".dropdown");
      const actionsBtn = tr.querySelector("button[id^='actions-']");
      if (actionsBtn && dropdownWrap) {
        actionsBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          bindDropdownGlobalHandlers();
          if (activeDropdown === dropdownWrap) {
            closeDropdown();
            return;
          }
          openDropdown(dropdownWrap, actionsBtn);
        });
        dropdownWrap.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const a = e.target.closest("a[data-key]");
          if (!a) return;
          const key = a.getAttribute("data-key");
          const actions = getAllowedActions(row);
          const found = actions.find(x => x.key === key);
          closeDropdown();
          if (found) found.handler();
        });
      }
    }

    async function fetchJSON(url, opts={}) {
      const resp = await fetch(url, {
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCsrfToken(),
        },
        ...opts,
      });
      if (!resp.ok) {
        let msg = "Request failed";
        try { const err = await resp.json(); msg = err.detail || JSON.stringify(err); } catch(e){}
        throw new Error(msg);
      }
      return resp.headers.get("content-type") && resp.headers.get("content-type").includes("application/json")
        ? resp.json()
        : resp.blob();
    }

    async function loadInvoices() {
      const url = API_BASE + "?page=" + state.page + (state.search ? ("&search=" + encodeURIComponent(state.search)) : "") + "&ordering=-date";
      try {
        const data = await fetchJSON(url);
        const tbody = document.getElementById("invoiceTbody");
        tbody.innerHTML = "";
        (data.results || []).forEach(row => {
          const html = rowHtml(row);
          const temp = document.createElement("tbody");
          temp.innerHTML = html.trim();
          const tr = temp.firstChild;
          tbody.appendChild(tr);
          bindRowInteractions(tr, row);
        });
        state.next = data.next;
        state.previous = data.previous;
        state.count = data.count || 0;
        const pageInfo = document.getElementById("pageInfo");
        pageInfo.textContent = "Page " + state.page + (state.count ? (" • " + state.count + " records") : "");
      } catch (e) {
        alert("Failed to load invoices: " + e.message);
      }
    }

    async function submitInvoice(id) {
      try {
        await fetchJSON(API_BASE + id + "/submit/", { method: "POST", body: "{}" });
        await loadInvoices();
      } catch(e) { alert("Submit failed: " + e.message); }
    }

    async function approveInvoice(id) {
      try {
        await fetchJSON(API_BASE + id + "/approve/", { method: "POST", body: "{}" });
        await loadInvoices();
      } catch(e) { alert("Approve failed: " + e.message); }
    }

    async function rejectInvoice(id) {
      const reason = prompt("Enter rejection comments (required):", "");
      if (!reason || !reason.trim()) {
        alert("Rejection requires comments.");
        return;
      }
      const payload = JSON.stringify({ notes: reason.trim() });
      try {
        await fetchJSON(API_BASE + id + "/reject/", { method: "POST", body: payload });
        await loadInvoices();
      } catch(e) { alert("Reject failed: " + e.message); }
    }

    async function disableInvoice(id) {
      if (!confirm("Disable this Approved invoice? This is a terminal status.")) return;
      try {
        await fetchJSON(API_BASE + id + "/disable/", { method: "POST", body: "{}" });
        await loadInvoices();
      } catch(e) { alert("Disable failed: " + e.message); }
    }

    async function pdfInvoiceDraft(id, consigneeName) {
      try {
        const resp = await fetch(API_BASE + id + "/pdf_draft/", { method: "GET", credentials: "same-origin" });
        if (!resp.ok) {
          let msg = "Draft PDF failed";
          try { const err = await resp.json(); msg = err.detail || JSON.stringify(err); } catch(e){}
          alert(msg);
          return;
        }
        const blob = await resp.blob();
        const dispo = resp.headers.get("Content-Disposition") || resp.headers.get("content-disposition") || "";
        let filename = "";
        const m = /filename="?([^"]+)"?/i.exec(dispo);
        if (m && m[1]) {
          filename = m[1];
        } else {
          const dateStr = formatTodayDdMonYYYY();
          const cons = sanitizeFilenameComponent(consigneeName || "");
          filename = `${dateStr}_CommercialInvoice_${cons || id}_DRAFT.pdf`;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch(e) { alert("Draft PDF failed: " + e.message); }
    }

    async function pdfInvoice(id, consigneeName) {
      try {
        const resp = await fetch(API_BASE + id + "/pdf/", { method: "GET", credentials: "same-origin" });
        if (!resp.ok) {
          let msg = "PDF failed";
          try { const err = await resp.json(); msg = err.detail || JSON.stringify(err); } catch(e){}
          alert(msg);
          return;
        }
        const blob = await resp.blob();
        const dispo = resp.headers.get("Content-Disposition") || resp.headers.get("content-disposition") || "";
        let filename = "";
        const m = /filename="?([^"]+)"?/i.exec(dispo);
        if (m && m[1]) {
          filename = m[1];
        } else {
          const dateStr = formatTodayDdMonYYYY();
          const cons = sanitizeFilenameComponent(consigneeName || "");
          filename = `${dateStr}_CommercialInvoice_${cons || id}.pdf`;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch(e) { alert("PDF failed: " + e.message); }
    }

    async function viewRejectionComments(id) {
      try {
        const data = await fetchJSON(API_BASE + id + "/audit/", { method: "GET" });
        const rejected = (data || []).find(a => a.action === "REJECTED");
        const msg = rejected && rejected.notes ? rejected.notes : "No rejection comment found.";
        alert(msg);
      } catch(e) { alert("Failed to load comments: " + e.message); }
    }

    document.getElementById("btnSearch").addEventListener("click", () => {
      state.search = document.getElementById("searchInput").value.trim();
      state.page = 1;
      loadInvoices();
    });
    document.getElementById("btnClear").addEventListener("click", () => {
      document.getElementById("searchInput").value = "";
      state.search = "";
      state.page = 1;
      loadInvoices();
    });
    document.getElementById("btnPrev").addEventListener("click", () => {
      if (state.previous) {
        state.page = Math.max(1, state.page - 1);
        loadInvoices();
      }
    });
    document.getElementById("btnNext").addEventListener("click", () => {
      if (state.next) {
        state.page = state.page + 1;
        loadInvoices();
      }
    });

    // Initial load
    loadInvoices();
  </script>
{% endblock %}